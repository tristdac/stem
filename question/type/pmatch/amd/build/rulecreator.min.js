define(["jquery"],function(a){var b={store:{},init:function(){a(".textareamonospace").each(function(){var c=a(this).attr("id").replace("id_answer_",""),d="id_"+c;b.store[d]=[],""!==a(this).val()?a(this).parent().parent().next().addClass("rc-hidden"):a(this).parent().parent().next().addClass("rcw");var e=a(this).parent().parent().next().find("div.rule-creator");e.attr("id","rc_"+c),a(this).parent().parent().next().find("a.rule-creator-btn").attr("id","rc_btn_"+c),e.find('div[class="rc-notice"]').attr("id","rc_notice_"+c),e.find('label[for="term"]').attr("for","rc_term_"+c),e.find('input[name="term"]').attr("id","rc_term_"+c),e.find('input[name="termadd"]').attr("id","rc_termadd_"+c).click(function(){return b.termAdd(c),!1}),e.find('input[name="termexclude"]').attr("id","rc_termexclude_"+c).click(function(){return b.termExclude(c),!1}),e.find('input[name="termor"]').attr("id","rc_termor_"+c).click(function(){return b.termOr(c),!1}),e.find('label[for="template"]').attr("for","rc_template_"+c),e.find('input[name="template"]').attr("id","rc_template_"+c),e.find('input[name="templateadd"]').attr("id","rc_templateadd_"+c).click(function(){return b.templateAdd(c),!1}),e.find('input[name="templateexclude"]').attr("id","rc_templateexclude_"+c).click(function(){return b.templateExclude(c),!1}),e.find('label[for="precedesadd"]').attr("for","rc_precedes1_"+c),e.find('select[name="precedes1"]').attr("id","rc_precedes1_"+c),e.find('select[name="precedes2"]').attr("id","rc_precedes2_"+c),e.find('input[name="precedesadd"]').attr("id","rc_precedesadd_"+c).click(function(){return b.precedesAdd(c),!1}),e.find('label[for="cprecedesadd"]').attr("for","rc_cprecedes1_"+c),e.find('select[name="cprecedes1"]').attr("id","rc_cprecedes1_"+c),e.find('select[name="cprecedes2"]').attr("id","rc_cprecedes2_"+c),e.find('input[name="cprecedesadd"]').attr("id","rc_cprecedesadd_"+c).click(function(){return b.cprecedesAdd(c),!1}),e.find("div.rc-result").attr("id","rc_result_"+c),e.find('input[name="add"]').attr("id","rc_add_"+c).click(function(){return b.addToAnswer(c),!1}),e.find('input[name="clear"]').attr("id","rc_clear_"+c).click(function(){return b.clear(c),!1})}),a(".rule-creator-btn").click(function(b){a(b.target).parent().parent().parent().find("div.rule-creator").slideToggle();var c=a(b.target).find("img.smallicon").attr("src");return c=c.indexOf("collapsed")>0?c.slice(0,-9)+"expanded":c.slice(0,-8)+"collapsed",a(b.target).find("img.smallicon").attr("src",c),!1})},termAdd:function(b){var c=this.getTerm(b,"term");if(!c)return void a("#rc_term_"+b).focus();var d=this.addToStore(b,c,"and","term");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_term_"+b).val("")},termExclude:function(b){var c=this.getTerm(b,"term");return c?(this.addToStore(b,c,"not","term"),this.disablePrecedes(b,!0),this.displayResult(b),void a("#rc_term_"+b).val("")):void a("#rc_term_"+b).focus()},termOr:function(b){var c=this.getTerm(b,"term");if(!c)return void a("#rc_term_"+b).focus();var d=this.addToStore(b,c,"or","term");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_term_"+b).val("")},templateAdd:function(b){var c=this.getTerm(b,"template");if(!c)return void a("#rc_template_"+b).focus();var d=this.addToStore(b,c,"and","template");this.addToPrecedes(b,d,c),this.displayResult(b),a("#rc_template_"+b).val("")},templateExclude:function(b){var c=this.getTerm(b,"template");return c?(this.addToStore(b,c,"not","template"),this.disablePrecedes(b,!0),this.displayResult(b),void a("#rc_template_"+b).val("")):void a("#rc_template_"+b).focus()},precedesAdd:function(a){var b=this.getPrecedesChoices(a,"precedes");b&&(this.addToStore(a,b,"precedes"),this.removeFromPrecedes(a,b),this.displayResult(a))},cprecedesAdd:function(a){var b=this.getPrecedesChoices(a,"cprecedes");b&&(this.addToStore(a,b,"cprecedes"),this.removeFromPrecedes(a,b),this.displayResult(a))},addToAnswer:function(b){var c=a("#rc_result_"+b).text();null!==c&&""!==c&&(a("#id_answer_"+b).val(c),this.clear(),a("#rc_btn_"+b).click(),a("#id_fraction_"+b).val("1.0").change(),a("#id_answer_"+b).focus())},clear:function(b){var c="id_"+b;this.store[c]=[],a("#rc_term_"+b).val(""),a("#rc_template_"+b).val(""),a("#rc_result_"+b).text(""),this.resetPrecedes(b)},getTerm:function(b,c){if(this.getStoreLength(b)>4)return a("#rc_notice_"+b).text(M.util.get_string("rulecreationtoomanyterms","qtype_pmatch")),!1;var d=a("#rc_"+c+"_"+b).val();return void 0===d||null===d||""===d?!1:(d=d.trim(),""===d?!1:d.indexOf(" ")>-1?!1:(d.indexOf("_")>-1&&(d=d.replace(/_/g,"\\_")),"term"===c?d:"*"===d.slice(-1)?d:d+"*"))},getPrecedesChoices:function(b,c){var d=a("#rc_"+c+"1_"+b).val();if("0"===d)return a("#rc_"+c+"1_"+b).focus(),!1;var e=a("#rc_"+c+"2_"+b).val();return"0"===e?(a("#rc_"+c+"2_"+b).focus(),!1):d===e?(a("#rc_"+c+"2_"+b).focus(),!1):[d,e]},addToPrecedes:function(b,c,d){a("#rc_precedes1_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_precedes2_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_cprecedes1_"+b).append(a("<option>",{value:c}).text(d)),a("#rc_cprecedes2_"+b).append(a("<option>",{value:c}).text(d))},disablePrecedes:function(b,c){a("#rc_precedes1_"+b).prop("disabled",c),a("#rc_precedes2_"+b).prop("disabled",c),a("#rc_cprecedes1_"+b).prop("disabled",c),a("#rc_cprecedes2_"+b).prop("disabled",c)},resetPrecedes:function(b){this.disablePrecedes(b,!1),a("#rc_precedes1_"+b).find('option[value!="0"]').remove(),a("#rc_precedes2_"+b).find('option[value!="0"]').remove(),a("#rc_cprecedes1_"+b).find('option[value!="0"]').remove(),a("#rc_cprecedes2_"+b).find('option[value!="0"]').remove()},removeFromPrecedes:function(b,c){var d;for(d=0;2>d;d++)a("#rc_precedes1_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_precedes2_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_cprecedes1_"+b+' option[value="'+c[d]+'"]').remove(),a("#rc_cprecedes2_"+b+' option[value="'+c[d]+'"]').remove()},addToStore:function(a,b,c,d){var e="id_"+a,f=this.store[e].length+1;return this.store[e].push({termid:f,term:b,op:c,type:d}),f},getStoreLength:function(a){var b="id_"+a;return this.store[b].length},getStoredResult:function(a){var b="id_"+a,c="",d=[],e=0,f=this.store[b].slice(0),g=f.length,h=0,i=0,j=0;if(0===g)return c;for(h=0;g>h;h++){var k="",l="";if(0===h){if("and"===f[h].op||"or"===f[h].op)k="term"===f[h].type?"match_w("+f[h].term+")":"match_wm("+f[h].term+")";else{if("not"!==f[h].op)continue;k="term"===f[h].type?"not(match_w("+f[h].term+"))":"not(match_wm("+f[h].term+"))"}d.push(k)}else{if(l=d[e],"and"===f[h].op)k="term"===f[h].type?l+" match_w("+f[h].term+")":l+" match_wm("+f[h].term+")";else if("not"===f[h].op)k="term"===f[h].type?l+" not(match_w("+f[h].term+"))":l+" not(match_wm("+f[h].term+"))";else if("or"===f[h].op)e++,k="match_w("+f[h].term+")";else if("precedes"===f[h].op)i=f[h].term[0]-1,j=f[h].term[1]-1,k=l+" match_w("+f[i].term+" "+f[j].term+")";else{if("cprecedes"!==f[h].op)continue;i=f[h].term[0]-1,j=f[h].term[1]-1,k=l+" match_w("+f[i].term+"_"+f[j].term+")"}d[e]=k}}for(g=d.length,h=0;g>h;h++)c=0===h?c+" match_all("+d[h]+")":" match_any("+c.trim()+" "+d[h]+")";return c.trim()},displayResult:function(b){var c=this.getStoredResult(b);a("#rc_result_"+b).text(c)}};return b});